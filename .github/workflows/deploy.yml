name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Comprehensive Fix for Figma Make Imports
        run: |
          echo "üîß Applying comprehensive fixes for Figma Make generated code..."
          
          python3 << 'PYTHON_EOF'
          import os
          import re
          import sys
          
          def fix_file(filepath):
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  original_content = content
                  
                  # Fix scoped packages: "@scope/package@1.2.3" -> "@scope/package"
                  content = re.sub(r'from\s+(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1', r'from \1\2\1', content)
                  # Fix regular packages: "package@1.2.3" -> "package"
                  content = re.sub(r'from\s+(["\'])([^@"\'\/]+)@[\d.]+\1', r'from \1\2\1', content)
                  # Fix dynamic imports
                  content = re.sub(r'import\s*\(\s*(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1\s*\)', r'import(\1\2\1)', content)
                  content = re.sub(r'import\s*\(\s*(["\'])([^@"\'\/]+)@[\d.]+\1\s*\)', r'import(\1\2\1)', content)
                  
                  if content != original_content:
                      with open(filepath, 'w', encoding='utf-8') as f:
                          f.write(content)
                      print(f"Fixed: {filepath}")
                      return True
                  return False
                  
              except Exception as e:
                  print(f"Error processing {filepath}: {e}", file=sys.stderr)
                  return False
          
          fixed_count = 0
          for root, dirs, files in os.walk('src'):
              dirs[:] = [d for d in dirs if d != 'node_modules']
              for file in files:
                  if file.endswith(('.ts', '.tsx', '.js', '.jsx')):
                      filepath = os.path.join(root, file)
                      if fix_file(filepath):
                          fixed_count += 1
          
          print(f"Summary: {fixed_count} files fixed")
          PYTHON_EOF
          
          echo "‚úÖ Import fixes applied"
      
      - name: Create missing configuration files
        run: |
          echo "üìù Creating configuration files if missing..."
          
          if [ ! -f "vite.config.ts" ]; then
            cat > vite.config.ts << 'EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react-swc'
          import path from 'path'
          
          export default defineConfig({
            plugins: [react()],
            base: '/',
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
              },
            },
          })
          EOF
            echo "‚úì Created vite.config.ts"
          fi
          
          if [ ! -f "tsconfig.json" ]; then
            cat > tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ES2020",
              "useDefineForClassFields": true,
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "module": "ESNext",
              "skipLibCheck": true,
              "moduleResolution": "bundler",
              "allowImportingTsExtensions": true,
              "resolveJsonModule": true,
              "isolatedModules": true,
              "noEmit": true,
              "jsx": "react-jsx",
              "strict": false,
              "baseUrl": ".",
              "paths": {
                "@/*": ["./src/*"]
              }
            },
            "include": ["src"]
          }
          EOF
            echo "‚úì Created tsconfig.json"
          fi
          
          if [ ! -f "tsconfig.node.json" ]; then
            cat > tsconfig.node.json << 'EOF'
          {
            "compilerOptions": {
              "composite": true,
              "skipLibCheck": true,
              "module": "ESNext",
              "moduleResolution": "bundler",
              "allowSyntheticDefaultImports": true
            },
            "include": ["vite.config.ts"]
          }
          EOF
            echo "‚úì Created tsconfig.node.json"
          fi
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps || npm install --legacy-peer-deps --force
          npm install --save-dev typescript @types/react @types/react-dom @types/node --legacy-peer-deps || true
      
      - name: Build
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          CI: false
      
      - name: Post-Build SEO and Routing Fixes
        run: |
          echo "üé® Applying post-build optimizations..."
          
          # 1. Create 404.html for SPA routing
          echo "üìÑ Creating 404.html for SPA routing..."
          cat > dist/404.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <title>Amas Team Wolf</title>
              <script>
                var pathSegmentsToKeep = 0;
                var l = window.location;
                l.replace(
                  l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
                  l.pathname.split('/').slice(0, 1 + pathSegmentsToKeep).join('/') + '/?/' +
                  l.pathname.slice(1).split('/').slice(pathSegmentsToKeep).join('/').replace(/&/g, '~and~') +
                  (l.search ? '&' + l.search.slice(1).replace(/&/g, '~and~') : '') +
                  l.hash
                );
              </script>
            </head>
            <body>
            </body>
          </html>
          EOF
          
          # 2. Enhance index.html with comprehensive meta tags
          echo "üè∑Ô∏è  Enhancing meta tags in index.html..."
          
          python3 << 'PYTHON_SCRIPT'
          import re
          
          # Read index.html
          with open('dist/index.html', 'r', encoding='utf-8') as f:
              html = f.read()
          
          # Meta tags to inject
          meta_tags = '''
              <!-- SEO Meta Tags -->
              <meta name="description" content="Amas Team Wolf - Academia de taekwondo en San Borja, Lima. Formamos ni√±os, j√≥venes y adultos con disciplina, valores y liderazgo. M√°s que un deporte: educaci√≥n para la vida.">
              <meta name="keywords" content="academia taekwondo Lima, taekwondo ni√±os Lima, clases artes marciales Lima, escuela taekwondo disciplina, taekwondo San Borja, formaci√≥n valores ni√±os Lima, Amas Team Wolf">
              <meta name="author" content="Amas Team Wolf">
              <meta name="geo.region" content="PE-LIM">
              <meta name="geo.placename" content="Lima, Per√∫">
              
              <!-- Open Graph Meta Tags -->
              <meta property="og:title" content="Amas Team Wolf - Academia de Taekwondo en Lima | Formamos L√≠deres">
              <meta property="og:description" content="Formamos ni√±os, j√≥venes y adultos con disciplina, respeto y liderazgo. Una comunidad que transforma vidas dentro y fuera del tatami.">
              <meta property="og:image" content="https://amasteamwolf.com/web-app-manifest-512x512.png">
              <meta property="og:url" content="https://amasteamwolf.com">
              <meta property="og:type" content="website">
              <meta property="og:site_name" content="Amas Team Wolf">
              <meta property="og:locale" content="es_PE">
              <meta property="og:image:width" content="1200">
              <meta property="og:image:height" content="630">
              
              <!-- Twitter Card Meta Tags -->
              <meta name="twitter:card" content="summary_large_image">
              <meta name="twitter:title" content="Amas Team Wolf - Academia de Taekwondo en Lima">
              <meta name="twitter:description" content="Formamos l√≠deres con disciplina, respeto y valores. Taekwondo para ni√±os, j√≥venes y adultos en Lima, Per√∫.">
              <meta name="twitter:image" content="https://amasteamwolf.com/web-app-manifest-512x512.png">
              
              <!-- WhatsApp Meta Tags -->
              <meta property="og:image:type" content="image/jpeg">
              
              <!-- Dynamic SEO Script -->
              <script>
                (function() {
                  // SPA redirect handler
                  var l = window.location;
                  if (l.search[1] === '/') {
                    var decoded = l.search.slice(1).split('&').map(function(s) { 
                      return s.replace(/~and~/g, '&');
                    }).join('?');
                    window.history.replaceState(null, null,
                      l.pathname.slice(0, -1) + decoded + l.hash
                    );
                  }
                  
                  // Dynamic meta tag updates based on route
                  function updateMetaTags() {
                    var path = window.location.pathname;
                    var pageConfig = {
                      '/': {
                        title: 'Amas Team Wolf - Academia de Taekwondo en Lima | Formamos L√≠deres',
                        description: 'Academia de taekwondo en Lima que forma ni√±os, j√≥venes y adultos con disciplina, valores y liderazgo. Descubre c√≥mo transformamos vidas dentro y fuera del tatami.',
                        url: 'https://amasteamwolf.com'
                      },
                      '/conversion': {
                        title: 'Inscr√≠bete en Amas Team Wolf | Academia de Taekwondo Lima',
                        description: '√önete a la manada Wolf. Inscripciones abiertas para ni√±os, j√≥venes y adultos. Formaci√≥n marcial con valores, disciplina y liderazgo en Lima, Per√∫.',
                        url: 'https://amasteamwolf.com/conversion'
                      },
                      '/tienda': {
                        title: 'Tienda Oficial Amas Team Wolf | Uniformes y Equipamiento',
                        description: 'Encuentra uniformes reglamentarios, guantes, combat weapons y todo el equipamiento oficial para tu entrenamiento de taekwondo en Amas Team Wolf.',
                        url: 'https://amasteamwolf.com/tienda'
                      },
                      '/graduacion': {
                        title: 'Graduaciones Amas Team Wolf | Ceremonia de Cinturones',
                        description: 'Celebramos el esfuerzo y progreso de nuestros alumnos. Conoce el programa de graduaciones y ascenso de cinturones en Amas team Team Wolf.',
                        url: 'https://amasteamwolf.com/graduacion'
                      },
                      '/programas': {
                        title: 'Programas de Taekwondo Amas Team Wolf | B√°sico, Fighter y Leadership',
                        description: 'Descubre nuestros programas: B√°sico (ni√±os desde 1 a√±o), Fighter Wolf (alto rendimiento) y Leadership Wolf (programa avanzado de uso de armas). Encuentra el tuyo.',
                        url: 'https://amasteamwolf.com/programas'
                      },
                      '/leadership': {
                        title: 'Programa Leadership Wolf | Programa avanzado de uso de armas',
                        description: 'Llega a otro nivel con el programa Leadership Wolf. Aprende nuevas t√©cnicas, conoce nuevas armas y obtener certificaciones oficiales Amas Team Wolf en Lima, Per√∫.',
                        url: 'https://amasteamwolf.com/leadership'
                      }
                    };
                    
                    var config = pageConfig[path] || {
                      title: 'Amas Team Wolf - Academia de Taekwondo en Lima',
                      description: 'Formamos personas fuertes, dentro y fuera del tatami. Academia de taekwondo con valores en Lima, Per√∫.',
                      url: 'https://amasteamwolf.com'
                    };
                    
                    document.title = config.title;
                    
                    function setMeta(attr, value, content) {
                      var meta = document.querySelector('meta[' + attr + '="' + value + '"]');
                      if (meta) meta.setAttribute('content', content);
                    }
                    
                    setMeta('name', 'description', config.description);
                    setMeta('property', 'og:title', config.title);
                    setMeta('property', 'og:description', config.description);
                    setMeta('property', 'og:url', config.url);
                    setMeta('name', 'twitter:title', config.title);
                    setMeta('name', 'twitter:description', config.description);
                    setMeta('name', 'twitter:url', config.url);
                  }
                  
                  // Update on load and route changes
                  updateMetaTags();
                  window.addEventListener('popstate', updateMetaTags);
                  
                  // Watch for route changes in SPA
                  var pushState = history.pushState;
                  history.pushState = function() {
                    pushState.apply(history, arguments);
                    updateMetaTags();
                  };
                })();
              </script>
          '''
          
          # Inject before </head>
          html = re.sub(r'</head>', meta_tags + '\n  </head>', html, count=1)
          
          # Write back
          with open('dist/index.html', 'w', encoding='utf-8') as f:
              f.write(html)
          
          print("‚úÖ Meta tags and SEO script injected")
          PYTHON_SCRIPT
          
          # 3. Create OG image placeholder if doesn't exist
          if [ ! -f "dist/web-app-manifest-512x512.png" ]; then
            echo "üì∑ Note: Add web-app-manifest-512x512.png to your repository for social sharing"
          fi
          
          echo "‚úÖ Post-build optimizations complete"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Deployment Summary
        run: |
          echo "üéâ Deployment completed successfully!"
          echo ""
          echo "üåê Your site: https://amasteamwolf.com"
          echo "üìä Features enabled:"
          echo "  ‚úÖ SPA routing (direct URL access)"
          echo "  ‚úÖ Dynamic SEO meta tags"
          echo "  ‚úÖ Open Graph for social sharing"
          echo "  ‚úÖ Twitter Cards"
          echo "  ‚úÖ WhatsApp preview"
          echo ""
          echo "üìù Next steps:"
          echo "  1. Add web-app-manifest-512x512.png to repository root"
          echo "  2. Test sharing URLs on WhatsApp/Twitter/Facebook"
          echo "  3. Verify all routes work: /conversion, /tienda, /graduacion"
