name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Comprehensive Fix for Figma Make Imports
        run: |
          echo "ðŸ”§ Applying comprehensive fixes for Figma Make generated code..."
          
          python3 << 'PYTHON_EOF'
          import os
          import re
          import sys
          
          def fix_file(filepath):
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  original_content = content
                  
                  # Fix scoped packages: "@scope/package@1.2.3" -> "@scope/package"
                  content = re.sub(r'from\s+(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1', r'from \1\2\1', content)
                  # Fix regular packages: "package@1.2.3" -> "package"
                  content = re.sub(r'from\s+(["\'])([^@"\'\/]+)@[\d.]+\1', r'from \1\2\1', content)
                  # Fix dynamic imports
                  content = re.sub(r'import\s*\(\s*(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1\s*\)', r'import(\1\2\1)', content)
                  content = re.sub(r'import\s*\(\s*(["\'])([^@"\'\/]+)@[\d.]+\1\s*\)', r'import(\1\2\1)', content)
                  
                  if content != original_content:
                      with open(filepath, 'w', encoding='utf-8') as f:
                          f.write(content)
                      print(f"Fixed: {filepath}")
                      return True
                  return False
                  
              except Exception as e:
                  print(f"Error processing {filepath}: {e}", file=sys.stderr)
                  return False
          
          fixed_count = 0
          for root, dirs, files in os.walk('src'):
              dirs[:] = [d for d in dirs if d != 'node_modules']
              for file in files:
                  if file.endswith(('.ts', '.tsx', '.js', '.jsx')):
                      filepath = os.path.join(root, file)
                      if fix_file(filepath):
                          fixed_count += 1
          
          print(f"Summary: {fixed_count} files fixed")
          PYTHON_EOF
          
          echo "âœ… Import fixes applied"
      
      - name: Create missing configuration files
        run: |
          echo "ðŸ“ Creating configuration files if missing..."
          
          if [ ! -f "vite.config.ts" ]; then
            cat > vite.config.ts << 'EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react-swc'
          import path from 'path'
          
          export default defineConfig({
            plugins: [react()],
            base: '/',
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
              },
            },
          })
          EOF
            echo "âœ“ Created vite.config.ts"
          fi
          
          if [ ! -f "tsconfig.json" ]; then
            cat > tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ES2020",
              "useDefineForClassFields": true,
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "module": "ESNext",
              "skipLibCheck": true,
              "moduleResolution": "bundler",
              "allowImportingTsExtensions": true,
              "resolveJsonModule": true,
              "isolatedModules": true,
              "noEmit": true,
              "jsx": "react-jsx",
              "strict": false,
              "baseUrl": ".",
              "paths": {
                "@/*": ["./src/*"]
              }
            },
            "include": ["src"]
          }
          EOF
            echo "âœ“ Created tsconfig.json"
          fi
          
          if [ ! -f "tsconfig.node.json" ]; then
            cat > tsconfig.node.json << 'EOF'
          {
            "compilerOptions": {
              "composite": true,
              "skipLibCheck": true,
              "module": "ESNext",
              "moduleResolution": "bundler",
              "allowSyntheticDefaultImports": true
            },
            "include": ["vite.config.ts"]
          }
          EOF
            echo "âœ“ Created tsconfig.node.json"
          fi
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps || npm install --legacy-peer-deps --force
          npm install --save-dev typescript @types/react @types/react-dom @types/node --legacy-peer-deps || true
      
      - name: Build
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          CI: false
      
      - name: Fix SPA routing for GitHub Pages
        run: |
          echo "ðŸ”§ Adding 404.html for SPA routing..."
          cat > dist/404.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <title>AMAS Team Wolf</title>
              <script>
                var pathSegmentsToKeep = 0;
                var l = window.location;
                l.replace(
                  l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
                  l.pathname.split('/').slice(0, 1 + pathSegmentsToKeep).join('/') + '/?/' +
                  l.pathname.slice(1).split('/').slice(pathSegmentsToKeep).join('/').replace(/&/g, '~and~') +
                  (l.search ? '&' + l.search.slice(1).replace(/&/g, '~and~') : '') +
                  l.hash
                );
              </script>
            </head>
            <body>
            </body>
          </html>
          EOF
          
          # Also add redirect script to index.html if not present
          if ! grep -q "spa-github-pages" dist/index.html; then
            echo "Adding SPA redirect script to index.html..."
            # Add script right after <head> tag
            sed -i 's|<head>|<head>\n    <script>\n      (function(l) {\n        if (l.search[1] === "/" ) {\n          var decoded = l.search.slice(1).split("&").map(function(s) { \n            return s.replace(/~and~/g, "&")\n          }).join("?");\n          window.history.replaceState(null, null,\n              l.pathname.slice(0, -1) + decoded + l.hash\n          );\n        }\n      }(window.location))\n    </script>|' dist/index.html
          fi
          
          echo "âœ… SPA routing configured"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
