name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Comprehensive Fix for Figma Make Imports
        run: |
          echo "üîß Applying comprehensive fixes for Figma Make generated code..."
          
          # Create a Python script to handle all edge cases
          cat > fix_imports.py << 'PYTHON_SCRIPT'
import os
import re
import sys

def fix_file(filepath):
    """Fix all import-related issues in a TypeScript/JavaScript file"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        
        # Pattern 1: Scoped packages with versions
        # from "@radix-ui/react-slot@1.1.2" -> from "@radix-ui/react-slot"
        content = re.sub(
            r'from\s+(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1',
            r'from \1\2\1',
            content
        )
        
        # Pattern 2: Regular packages with versions
        # from "sonner@2.0.3" -> from "sonner"
        content = re.sub(
            r'from\s+(["\'])([^@"\'\/]+)@[\d.]+\1',
            r'from \1\2\1',
            content
        )
        
        # Pattern 3: import() dynamic imports with versions
        # import("package@1.2.3") -> import("package")
        content = re.sub(
            r'import\s*\(\s*(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1\s*\)',
            r'import(\1\2\1)',
            content
        )
        content = re.sub(
            r'import\s*\(\s*(["\'])([^@"\'\/]+)@[\d.]+\1\s*\)',
            r'import(\1\2\1)',
            content
        )
        
        # Pattern 4: require() with versions
        # require("package@1.2.3") -> require("package")
        content = re.sub(
            r'require\s*\(\s*(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1\s*\)',
            r'require(\1\2\1)',
            content
        )
        content = re.sub(
            r'require\s*\(\s*(["\'])([^@"\'\/]+)@[\d.]+\1\s*\)',
            r'require(\1\2\1)',
            content
        )
        
        # Pattern 5: export from with versions
        # export { ... } from "package@1.2.3"
        content = re.sub(
            r'from\s+(["\'])(@[^/]+/[^@"\']+)@[\d.]+\1',
            r'from \1\2\1',
            content
        )
        
        # Pattern 6: Fix any remaining @version patterns in strings
        # This is more aggressive but safe for import statements
        content = re.sub(
            r'(from|import|require)\s*\(?\s*(["\'])([^"\']*?)@[\d.]+\2',
            r'\1(\2\3\2',
            content
        )
        
        # Only write if content changed
        if content != original_content:
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"‚úì Fixed: {filepath}")
            return True
        return False
        
    except Exception as e:
        print(f"‚úó Error processing {filepath}: {e}", file=sys.stderr)
        return False

def main():
    fixed_count = 0
    error_count = 0
    
    # Walk through all TypeScript/JavaScript files
    for root, dirs, files in os.walk('src'):
        # Skip node_modules
        dirs[:] = [d for d in dirs if d != 'node_modules']
        
        for file in files:
            if file.endswith(('.ts', '.tsx', '.js', '.jsx')):
                filepath = os.path.join(root, file)
                try:
                    if fix_file(filepath):
                        fixed_count += 1
                except Exception as e:
                    print(f"‚úó Failed to process {filepath}: {e}", file=sys.stderr)
                    error_count += 1
    
    print(f"\nüìä Summary: {fixed_count} files fixed, {error_count} errors")
    return 0 if error_count == 0 else 1

if __name__ == '__main__':
    sys.exit(main())
PYTHON_SCRIPT
          
          # Run the Python script
          python3 fix_imports.py
          
          echo "‚úÖ All import fixes applied"
      
      - name: Create missing configuration files
        run: |
          echo "üìù Creating configuration files if missing..."
          
          # Create vite.config.ts if it doesn't exist
          if [ ! -f "vite.config.ts" ]; then
            cat > vite.config.ts << 'EOF'
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  base: '/',
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom'],
          'ui-vendor': ['@radix-ui/react-accordion', '@radix-ui/react-alert-dialog', '@radix-ui/react-avatar'],
        },
      },
    },
  },
})
EOF
            echo "‚úì Created vite.config.ts"
          fi
          
          # Create tsconfig.json if it doesn't exist
          if [ ! -f "tsconfig.json" ]; then
            cat > tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": false,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
EOF
            echo "‚úì Created tsconfig.json"
          fi
          
          # Create tsconfig.node.json if it doesn't exist
          if [ ! -f "tsconfig.node.json" ]; then
            cat > tsconfig.node.json << 'EOF'
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
EOF
            echo "‚úì Created tsconfig.node.json"
          fi
      
      - name: Install dependencies with error handling
        run: |
          echo "üì¶ Installing dependencies..."
          
          # Install with legacy peer deps to handle version conflicts
          npm install --legacy-peer-deps || {
            echo "‚ö†Ô∏è First install attempt failed, trying with --force..."
            npm install --legacy-peer-deps --force
          }
          
          # Install dev dependencies
          npm install --save-dev typescript @types/react @types/react-dom @types/node --legacy-peer-deps || true
          
          # Verify critical packages are installed
          echo "üîç Verifying installations..."
          npm list react react-dom vite || echo "‚ö†Ô∏è Some packages may need reinstallation"
          
          echo "‚úÖ Dependencies installed"
      
      - name: Pre-build diagnostics
        run: |
          echo "üîç Running pre-build diagnostics..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "TypeScript version: $(npx tsc --version || echo 'Not found')"
          echo "Vite version: $(npx vite --version || echo 'Not found')"
          
          echo "üìÅ Project structure:"
          ls -la
          
          echo "üì¶ Key files present:"
          [ -f "package.json" ] && echo "‚úì package.json" || echo "‚úó package.json"
          [ -f "vite.config.ts" ] && echo "‚úì vite.config.ts" || echo "‚úó vite.config.ts"
          [ -f "tsconfig.json" ] && echo "‚úì tsconfig.json" || echo "‚úó tsconfig.json"
          [ -f "index.html" ] && echo "‚úì index.html" || echo "‚úó index.html"
          [ -d "src" ] && echo "‚úì src/" || echo "‚úó src/"
      
      - name: Build with enhanced error handling
        run: |
          echo "üèóÔ∏è Building project..."
          
          # Try building with increased memory and better error output
          npm run build 2>&1 | tee build.log || {
            echo "‚ùå Build failed. Analyzing errors..."
            
            # Check for common errors
            if grep -q "Cannot find module" build.log; then
              echo "‚ö†Ô∏è Missing module detected. Checking imports..."
              grep "Cannot find module" build.log
            fi
            
            if grep -q "Unexpected token" build.log; then
              echo "‚ö†Ô∏è Syntax error detected. Check recent changes..."
              grep "Unexpected token" build.log
            fi
            
            if grep -q "out of memory" build.log; then
              echo "‚ö†Ô∏è Out of memory. Trying with more allocation..."
              NODE_OPTIONS="--max-old-space-size=8192" npm run build
            else
              # Re-throw error
              exit 1
            fi
          }
          
          echo "‚úÖ Build completed successfully"
          
          # Verify dist folder
          if [ -d "dist" ]; then
            echo "üìä Build output:"
            ls -lh dist/
            du -sh dist/
          else
            echo "‚ùå dist folder not created!"
            exit 1
          fi
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          CI: false
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment summary
        if: always()
        run: |
          echo "üéâ Deployment completed!"
          echo "üåê Your site should be available at: https://amasteamwolf.com"
          echo "‚è∞ DNS propagation may take a few minutes"
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
